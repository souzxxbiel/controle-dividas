<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Controle de Vendas & Dívidas — Premium</title>
<meta name="description" content="App completo para controle de produtos, vendas e dívidas, com dashboard, gráficos, exportação e dark mode." />
<style>
  /* Reset e base */
  *, *::before, *::after {box-sizing: border-box;}
  body {
    margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
      Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    background: #f9fafb; color: #111;
    min-height: 100vh;
    display: flex; flex-direction: column;
  }
  html.dark body {
    background: #121212; color: #eee;
  }
  main {flex-grow: 1; padding-bottom: 64px;}
  button {
    cursor: pointer; border: none; background: none;
  }
  button:focus-visible {
    outline: 2px solid #2563eb; outline-offset: 2px;
  }
  /* Container */
  section {
    max-width: 700px; margin: auto; padding: 1rem;
  }
  h2 {
    font-size: 1.4rem; font-weight: 700; margin-bottom: .75rem;
  }
  label {
    display: block; margin-bottom: .3rem; font-weight: 600;
  }
  input, select {
    width: 100%; padding: .5rem; margin-bottom: 1rem; font-size: 1rem;
    border: 1px solid #ccc; border-radius: 6px;
    background: #fff; color: #111;
    transition: border-color 0.3s;
  }
  html.dark input, html.dark select {
    background: #222; color: #eee; border-color: #555;
  }
  input:focus, select:focus {
    border-color: #2563eb; outline: none;
  }
  form {
    background: #fff; padding: 1rem; border-radius: 8px;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.05);
  }
  html.dark form {
    background: #1e1e1e;
    box-shadow: 0 2px 10px rgb(0 0 0 / 0.7);
  }
  /* Botões principais */
  .btn-primary {
    background-color: #2563eb; color: white;
    padding: 0.7rem 1.2rem; border-radius: 8px;
    font-weight: 700; font-size: 1rem;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  .btn-primary:hover {
    background-color: #1d4ed8;
  }
  .btn-primary:disabled {
    background-color: #94a3b8; cursor: not-allowed;
  }
  /* Tabela */
  table {
    width: 100%; border-collapse: collapse; margin-top: 1rem;
  }
  th, td {
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid #ddd;
    text-align: left;
    font-size: 0.9rem;
    vertical-align: middle;
  }
  html.dark th, html.dark td {
    border-color: #444;
  }
  th {
    background: #f3f4f6; color: #111;
    user-select: none;
    cursor: pointer;
    position: relative;
  }
  html.dark th {
    background: #222;
    color: #eee;
  }
  th[aria-pressed="true"]::after {
    content: "▲";
    position: absolute;
    right: 0.75rem;
    font-size: 0.8rem;
    color: #2563eb;
  }
  th[aria-pressed="false"]::after {
    content: "▼";
    position: absolute;
    right: 0.75rem;
    font-size: 0.8rem;
    color: #aaa;
  }
  tr:hover {
    background-color: #e0e7ff;
  }
  html.dark tr:hover {
    background-color: #2a2a4a;
  }
  .text-center {
    text-align: center;
  }
  .text-yellow {
    color: #ca8a04;
  }
  .text-green {
    color: #16a34a;
  }
  .text-red {
    color: #dc2626;
  }
  /* Inputs inline para tabelas e formulários */
  input[type="number"], input[type="date"] {
    width: auto;
  }
  /* Rodapé Tabs */
  nav#bottomNav {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: #fff; border-top: 1px solid #ddd;
    display: flex; justify-content: space-around;
    padding: 0.4rem 0;
    z-index: 1000;
  }
  html.dark nav#bottomNav {
    background: #121212;
    border-color: #444;
  }
  nav#bottomNav button {
    flex-grow: 1;
    display: flex; flex-direction: column; align-items: center;
    color: #6b7280;
    font-size: 0.75rem;
    gap: 0.15rem;
    padding: 0.35rem 0;
    user-select: none;
    transition: color 0.3s;
  }
  nav#bottomNav button.active, nav#bottomNav button:hover, nav#bottomNav button:focus-visible {
    color: #2563eb;
  }
  nav#bottomNav svg {
    width: 1.4rem; height: 1.4rem;
    stroke-width: 2.2;
  }
  /* Notificação */
  #notification {
    position: fixed;
    bottom: 80px;
    left: 50%; transform: translateX(-50%);
    background-color: #2563eb;
    color: white;
    padding: 0.7rem 1.3rem;
    border-radius: 9999px;
    font-weight: 600;
    font-size: 0.95rem;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease;
    z-index: 1100;
  }
  #notification.show {
    opacity: 1;
    pointer-events: auto;
  }
  /* Dark Mode toggle */
  #darkToggle {
    position: fixed;
    top: 0.8rem; right: 1rem;
    background: none;
    border-radius: 50%;
    padding: 0.4rem;
    transition: background-color 0.3s;
  }
  #darkToggle:hover, #darkToggle:focus-visible {
    background-color: #2563eb;
    color: white;
    outline: none;
  }
  #darkToggle svg {
    width: 1.6rem;
    height: 1.6rem;
    stroke-width: 2;
  }
  /* Forms flex */
  .form-row {
    display: flex; gap: 1rem; flex-wrap: wrap;
  }
  .form-row > div {
    flex: 1 1 120px;
    min-width: 120px;
  }
  /* Responsive */
  @media (max-width: 500px) {
    nav#bottomNav button span {
      font-size: 0.65rem;
    }
    th, td {
      font-size: 0.85rem;
      padding: 0.35rem 0.5rem;
    }
  }
</style>
</head>
<body>
<button id="darkToggle" aria-label="Alternar modo claro/escuro" title="Alternar modo claro/escuro" type="button">
  <svg id="iconMoon" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true" >
    <path stroke-linecap="round" stroke-linejoin="round" d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z"/>
  </svg>
  <svg id="iconSun" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true" class="hidden" >
    <circle cx="12" cy="12" r="5" />
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 1v2m0 18v2m11-11h-2M3 12H1m16.95 5.95l-1.414-1.414M6.464 6.464L5.05 5.05m12.728 0l-1.414 1.414M6.464 17.536l-1.414 1.414"/>
  </svg>
</button>

<main>
  <!-- Aba Produtos -->
  <section id="tabProdutos" tabindex="0" role="tabpanel" aria-label="Produtos">
    <h2>Produtos</h2>
    <form id="produtoForm" aria-describedby="produtoFormDesc">
      <div id="produtoFormDesc" class="sr-only">Formulário para adicionar novo produto com nome, valor e custo.</div>
      <label for="nomeProduto">Nome do Produto</label>
      <input id="nomeProduto" name="nomeProduto" type="text" minlength="3" maxlength="50" placeholder="Ex: Camiseta" required autocomplete="off" />
      <div class="form-row">
        <div>
          <label for="valorProduto">Valor Unitário (R$)</label>
          <input id="valorProduto" name="valorProduto" type="number" min="0" step="0.01" placeholder="0,00" required />
        </div>
        <div>
          <label for="custoProduto">Custo Unitário (R$)</label>
          <input id="custoProduto" name="custoProduto" type="number" min="0" step="0.01" placeholder="0,00" required />
        </div>
      </div>
      <button class="btn-primary" type="submit">Adicionar Produto</button>
    </form>

    <table aria-describedby="produtosTabelaDesc" aria-live="polite" role="grid">
      <caption id="produtosTabelaDesc" class="sr-only">Lista de produtos cadastrados</caption>
      <thead>
        <tr>
          <th scope="col">Nome</th>
          <th scope="col">Valor</th>
          <th scope="col">Custo</th>
          <th scope="col" class="text-center">Excluir</th>
        </tr>
      </thead>
      <tbody id="produtosTabela"></tbody>
    </table>
  </section>

  <!-- Aba Vendas -->
  <section id="tabVendas" tabindex="0" role="tabpanel" aria-label="Vendas" hidden>
    <h2>Vendas & Dívidas</h2>
    <form id="vendaForm" aria-describedby="vendaFormDesc">
      <div id="vendaFormDesc" class="sr-only">Formulário para registrar vendas e dívidas.</div>
      <label for="devedorVenda">Nome do Devedor</label>
      <input id="devedorVenda" name="devedorVenda" type="text" placeholder="Ex: João" required autocomplete="off" list="devedores" />
      <datalist id="devedores"></datalist>

      <label for="produtoVenda">Produto</label>
      <input id="produtoVenda" name="produtoVenda" type="text" placeholder="Selecione um produto" required autocomplete="off" list="produtosDatalist" />
      <datalist id="produtosDatalist"></datalist>

      <div class="form-row">
        <div>
          <label for="quantidadeVenda">Quantidade</label>
          <input id="quantidadeVenda" name="quantidadeVenda" type="number" min="1" step="1" value="1" required />
        </div>
        <div>
          <label for="valorVenda">Valor Unitário (R$)</label>
          <input id="valorVenda" name="valorVenda" type="number" min="0" step="0.01" placeholder="0,00" required />
        </div>
      </div>

      <label for="vencimentoVenda">Data de Vencimento</label>
      <input id="vencimentoVenda" name="vencimentoVenda" type="date" required />

      <button class="btn-primary" type="submit">Registrar Venda</button>
    </form>

    <input id="buscaVendas" type="search" placeholder="Buscar vendas por nome ou produto..." aria-label="Buscar vendas" style="margin-top: 1rem; width: 100%; padding: 0.5rem; border-radius: 8px; border: 1px solid #ccc;" />

    <table aria-describedby="vendasTabelaDesc" aria-live="polite" role="grid" style="margin-top: 1rem;">
      <caption id="vendasTabelaDesc" class="sr-only">Lista de vendas e dívidas registradas</caption>
      <thead>
        <tr>
          <th scope="col" data-sort="devedor" tabindex="0" role="button" aria-pressed="false" aria-label="Ordenar por Devedor">Devedor</th>
          <th scope="col" data-sort="produto" tabindex="0" role="button" aria-pressed="false" aria-label="Ordenar por Produto">Produto</th>
          <th scope="col" data-sort="quantidade" tabindex="0" role="button" aria-pressed="false" aria-label="Ordenar por Quantidade" class="text-center">Qtd</th>
          <th scope="col" data-sort="valor" tabindex="0" role="button" aria-pressed="false" aria-label="Ordenar por Valor Unitário">Valor Unit.</th>
          <th scope="col" class="text-center">Custo Total</th>
          <th scope="col" class="text-center">Lucro</th>
          <th scope="col" data-sort="vencimento" tabindex="0" role="button" aria-pressed="false" aria-label="Ordenar por Data de Vencimento">Vencimento</th>
          <th scope="col" data-sort="status" tabindex="0" role="button" aria-pressed="false" aria-label="Ordenar por Status">Status</th>
          <th scope="col" class="text-center">Ações</th>
        </tr>
      </thead>
      <tbody id="vendasTabela"></tbody>
    </table>
  </section>

  <!-- Aba Dashboard -->
  <section id="tabDashboard" tabindex="0" role="tabpanel" aria-label="Dashboard" hidden>
    <h2>Dashboard & Estatísticas</h2>
    <div style="display:flex; flex-wrap: wrap; gap:1rem; margin-bottom: 1rem;">
      <div style="flex:1 1 150px; background:#2563eb; color:#fff; border-radius: 12px; padding: 1rem; box-shadow: 0 3px 8px rgb(37 99 235 / 0.4);">
        <strong>Total Recebido</strong>
        <p id="totalRecebido" style="font-size:1.5rem; margin-top: 0.3rem;">R$ 0,00</p>
      </div>
      <div style="flex:1 1 150px; background:#fbbf24; color:#000; border-radius: 12px; padding: 1rem; box-shadow: 0 3px 8px rgb(251 191 36 / 0.4);">
        <strong>Total a Receber</strong>
        <p id="totalAReceber" style="font-size:1.5rem; margin-top: 0.3rem;">R$ 0,00</p>
      </div>
      <div style="flex:1 1 150px; background:#dc2626; color:#fff; border-radius: 12px; padding: 1rem; box-shadow: 0 3px 8px rgb(220 38 38 / 0.4);">
        <strong>Custo Total</strong>
        <p id="totalCusto" style="font-size:1.5rem; margin-top: 0.3rem;">R$ 0,00</p>
      </div>
      <div style="flex:1 1 150px; background:#16a34a; color:#fff; border-radius: 12px; padding: 1rem; box-shadow: 0 3px 8px rgb(22 163 74 / 0.4);">
        <strong>Lucro Total</strong>
        <p id="lucroTotal" style="font-size:1.5rem; margin-top: 0.3rem;">R$ 0,00</p>
      </div>
    </div>
    <canvas id="graficoProdutos" aria-label="Gráfico de barras de produtos mais vendidos" role="img" style="max-width: 100%; height: 280px;"></canvas>
    <canvas id="graficoStatus" aria-label="Gráfico de pizza dos status das vendas" role="img" style="max-width: 100%; height: 280px; margin-top: 1rem;"></canvas>

    <div style="margin-top: 1.5rem; display:flex; gap:1rem; flex-wrap: wrap; justify-content:center;">
      <button id="exportCsvBtn" class="btn-primary" style="flex:1 1 200px;">Exportar CSV</button>
      <button id="exportPdfBtn" class="btn-primary" style="flex:1 1 200px;">Exportar PDF</button>
    </div>
  </section>
</main>

<nav id="bottomNav" role="tablist" aria-label="Navegação das abas">
  <button role="tab" aria-selected="true" aria-controls="tabProdutos" data-tab="tabProdutos" tabindex="0" title="Produtos" aria-label="Ir para aba Produtos">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" viewBox="0 0 24 24" >
      <path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7" />
      <path stroke-linecap="round" stroke-linejoin="round" d="M3 7l9 6 9-6" />
    </svg>
    <span>Produtos</span>
  </button>
  <button role="tab" aria-selected="false" aria-controls="tabVendas" data-tab="tabVendas" tabindex="-1" title="Vendas e Dívidas" aria-label="Ir para aba Vendas e Dívidas">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" viewBox="0 0 24 24" >
      <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 6h10M7 14h8m-5 4h3" />
    </svg>
    <span>Vendas</span>
  </button>
  <button role="tab" aria-selected="false" aria-controls="tabDashboard" data-tab="tabDashboard" tabindex="-1" title="Dashboard" aria-label="Ir para aba Dashboard">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" viewBox="0 0 24 24" >
      <path stroke-linecap="round" stroke-linejoin="round" d="M3 3v18h18" />
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-6h6v6" />
    </svg>
    <span>Dashboard</span>
  </button>
</nav>

<div id="notification" role="alert" aria-live="assertive" aria-atomic="true"></div>

<!-- Dependências via CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<script>
(() => {
  'use strict';

  // Utilitários
  const formatBRL = n => n.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
  const formatDateBR = d => {
    if (!d) return '';
    const dt = new Date(d);
    if (isNaN(dt)) return '';
    return dt.toLocaleDateString('pt-BR');
  };
  const compareDate = (a,b) => new Date(a) - new Date(b);

  // Elements
  const tabs = {
    produtos: document.getElementById('tabProdutos'),
    vendas: document.getElementById('tabVendas'),
    dashboard: document.getElementById('tabDashboard')
  };
  const tabButtons = [...document.querySelectorAll('nav#bottomNav button')];

  // Notificação
  const notificationEl = document.getElementById('notification');
  let notifTimeout = null;
  function showNotification(msg) {
    notificationEl.textContent = msg;
    notificationEl.classList.add('show');
    clearTimeout(notifTimeout);
    notifTimeout = setTimeout(() => notificationEl.classList.remove('show'), 3000);
  }

  // Dark Mode Toggle
  const darkToggle = document.getElementById('darkToggle');
  const iconMoon = document.getElementById('iconMoon');
  const iconSun = document.getElementById('iconSun');

  function setDarkMode(dark) {
    if (dark) {
      document.documentElement.classList.add('dark');
      iconMoon.classList.add('hidden');
      iconSun.classList.remove('hidden');
    } else {
      document.documentElement.classList.remove('dark');
      iconMoon.classList.remove('hidden');
      iconSun.classList.add('hidden');
    }
    localStorage.setItem('darkMode', dark ? '1' : '0');
  }

  darkToggle.addEventListener('click', () => {
    const dark = document.documentElement.classList.contains('dark');
    setDarkMode(!dark);
  });

  // Inicializa modo dark baseado no localStorage
  setDarkMode(localStorage.getItem('darkMode') === '1');

  // SPA Navegação entre abas
  function setActiveTab(tabId) {
    for (const key in tabs) {
      const section = tabs[key];
      const isActive = section.id === tabId;
      section.hidden = !isActive;
      section.classList.toggle('active', isActive);
      const btn = tabButtons.find(b => b.dataset.tab === tabId);
      if(btn){
        tabButtons.forEach(b => {
          b.classList.remove('active');
          b.setAttribute('aria-selected', 'false');
          b.tabIndex = -1;
        });
        btn.classList.add('active');
        btn.setAttribute('aria-selected', 'true');
        btn.tabIndex = 0;
        btn.focus();
      }
    }
  }

  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      setActiveTab(btn.dataset.tab);
    });
    btn.addEventListener('keydown', (e) => {
      let idx = tabButtons.indexOf(e.currentTarget);
      if(e.key === 'ArrowRight') {
        idx = (idx + 1) % tabButtons.length;
        tabButtons[idx].focus();
      } else if(e.key === 'ArrowLeft') {
        idx = (idx - 1 + tabButtons.length) % tabButtons.length;
        tabButtons[idx].focus();
      } else if(e.key === 'Enter' || e.key === ' ') {
        setActiveTab(e.currentTarget.dataset.tab);
      }
    });
  });

  // Inicializa aba Produtos
  const produtoForm = document.getElementById('produtoForm');
  const produtosTabela = document.getElementById('produtosTabela');
  const nomeProdutoInput = document.getElementById('nomeProduto');
  const valorProdutoInput = document.getElementById('valorProduto');
  const custoProdutoInput = document.getElementById('custoProduto');

  // Aba Vendas elementos
  const vendaForm = document.getElementById('vendaForm');
  const vendasTabela = document.getElementById('vendasTabela');
  const buscaVendasInput = document.getElementById('buscaVendas');
  const devedoresDatalist = document.getElementById('devedores');
  const produtosDatalist = document.getElementById('produtosDatalist');
  const devedorVendaInput = document.getElementById('devedorVenda');
  const produtoVendaInput = document.getElementById('produtoVenda');
  const quantidadeVendaInput = document.getElementById('quantidadeVenda');
  const valorVendaInput = document.getElementById('valorVenda');
  const vencimentoVendaInput = document.getElementById('vencimentoVenda');

  // Dashboard elementos
  const totalRecebidoEl = document.getElementById('totalRecebido');
  const totalAReceberEl = document.getElementById('totalAReceber');
  const totalCustoEl = document.getElementById('totalCusto');
  const lucroTotalEl = document.getElementById('lucroTotal');
  const graficoProdutosCtx = document.getElementById('graficoProdutos').getContext('2d');
  const graficoStatusCtx = document.getElementById('graficoStatus').getContext('2d');

  // Dados
  let produtos = {};
  let vendas = [];
  let ordenacao = { campo: null, asc: true };

  // Salvar e carregar localStorage
  function salvarDados() {
    localStorage.setItem('controleProdutos', JSON.stringify(produtos));
    localStorage.setItem('controleVendas', JSON.stringify(vendas));
  }
  function carregarDados() {
    const p = localStorage.getItem('controleProdutos');
    if (p) produtos = JSON.parse(p);
    const v = localStorage.getItem('controleVendas');
    if (v) vendas = JSON.parse(v);
  }

  // Renderiza produtos na tabela
  function renderProdutos() {
    produtosTabela.innerHTML = '';
    produtosDatalist.innerHTML = '';
    for (const [nome, info] of Object.entries(produtos)) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${nome}</td>
        <td>${formatBRL(info.valor)}</td>
        <td>${formatBRL(info.custo)}</td>
        <td class="text-center">
          <button aria-label="Excluir produto ${nome}" title="Excluir produto ${nome}" class="btnExcluirProduto" data-nome="${nome}" style="color:#dc2626;font-weight:bold;font-size:1.1rem;">&#10060;</button>
        </td>
      `;
      produtosTabela.appendChild(tr);

      // datalist produto para venda
      const opt = document.createElement('option');
      opt.value = nome;
      produtosDatalist.appendChild(opt);
    }
  }

  // Renderiza devedores para datalist
  function renderDevedores() {
    devedoresDatalist.innerHTML = '';
    const nomes = [...new Set(vendas.map(v => v.devedor).filter(Boolean))].sort();
    nomes.forEach(n => {
      const opt = document.createElement('option');
      opt.value = n;
      devedoresDatalist.appendChild(opt);
    });
  }

  // Render vendas tabela com busca, ordenação e filtro
  function renderVendasTabela() {
    const busca = buscaVendasInput.value.trim().toLowerCase();
    let vendasFiltradas = vendas.slice();

    // Busca
    if (busca.length > 0) {
      vendasFiltradas = vendasFiltradas.filter(v =>
        v.devedor.toLowerCase().includes(busca) || v.produto.toLowerCase().includes(busca)
      );
    }

    // Ordenação
    if (ordenacao.campo) {
      vendasFiltradas.sort((a, b) => {
        let va = a[ordenacao.campo];
        let vb = b[ordenacao.campo];

        if (ordenacao.campo === 'vencimento') {
          va = new Date(va);
          vb = new Date(vb);
          return ordenacao.asc ? va - vb : vb - va;
        }
        if (typeof va === 'string') {
          va = va.toLowerCase();
          vb = vb.toLowerCase();
          return ordenacao.asc ? va.localeCompare(vb) : vb.localeCompare(va);
        }
        if (typeof va === 'number') {
          return ordenacao.asc ? va - vb : vb - va;
        }
        return 0;
      });
    }

    vendasTabela.innerHTML = '';
    if (vendasFiltradas.length === 0) {
      vendasTabela.innerHTML = `<tr><td colspan="9" class="text-center" style="padding:1rem; color:#777;">Nenhuma venda encontrada.</td></tr>`;
      return;
    }

    vendasFiltradas.forEach(v => {
      const tr = document.createElement('tr');

      // status cores
      const statusColor = {
        "Pendente": "text-yellow",
        "Recebido": "text-green",
        "Cancelado": "text-red"
      }[v.status] || "";

      const custoTotal = produtos[v.produto] ? produtos[v.produto].custo * v.quantidade : 0;
      const lucro = (v.valor * v.quantidade) - custoTotal;

      tr.innerHTML = `
        <td>${v.devedor}</td>
        <td>${v.produto}</td>
        <td class="text-center">${v.quantidade}</td>
        <td>${formatBRL(v.valor)}</td>
        <td class="text-center">${formatBRL(custoTotal)}</td>
        <td class="text-center">${formatBRL(lucro)}</td>
        <td>${formatDateBR(v.vencimento)}</td>
        <td class="${statusColor} font-semibold">${v.status}</td>
        <td class="text-center" style="white-space: nowrap;">
          ${v.status === 'Pendente' ? `<button title="Marcar como Recebido" aria-label="Marcar venda de ${v.devedor} como Recebido" class="btnRecebido" data-id="${v.id}" style="color:#16a34a; font-weight: bold;">&#10004;</button>` : ""}
          ${v.status !== 'Cancelado' ? `<button title="Cancelar venda" aria-label="Cancelar venda de ${v.devedor}" class="btnCancelar" data-id="${v.id}" style="color:#dc2626; font-weight: bold;">&#10060;</button>` : ""}
        </td>
      `;
      vendasTabela.appendChild(tr);
    });

    // Ações dos botões na tabela
    document.querySelectorAll('.btnRecebido').forEach(btn => {
      btn.onclick = () => {
        const venda = vendas.find(v => v.id === btn.dataset.id);
        if (venda && venda.status === 'Pendente') {
          venda.status = 'Recebido';
          salvarDados();
          renderVendasTabela();
          renderDashboard();
          renderDevedores();
          showNotification("Venda marcada como Recebida.");
        }
      };
    });
    document.querySelectorAll('.btnCancelar').forEach(btn => {
      btn.onclick = () => {
        const venda = vendas.find(v => v.id === btn.dataset.id);
        if (venda && venda.status !== 'Cancelado') {
          if (confirm("Deseja cancelar esta venda? Esta ação não pode ser desfeita.")) {
            venda.status = 'Cancelado';
            salvarDados();
            renderVendasTabela();
            renderDashboard();
            renderDevedores();
            showNotification("Venda cancelada.");
          }
        }
      };
    });
  }

  // Render dashboard
  let chartProdutos = null;
  let chartStatus = null;
  function renderDashboard() {
    // Totais
    const totalRecebido = vendas.filter(v => v.status === 'Recebido').reduce((acc, v) => acc + v.valor * v.quantidade, 0);
    const totalAReceber = vendas.filter(v => v.status === 'Pendente').reduce((acc, v) => acc + v.valor * v.quantidade, 0);
    const totalCusto = vendas.filter(v => v.status !== 'Cancelado').reduce((acc, v) => {
      if (produtos[v.produto]) return acc + produtos[v.produto].custo * v.quantidade;
      return acc;
    }, 0);
    const lucroTotal = totalRecebido - totalCusto;

    totalRecebidoEl.textContent = formatBRL(totalRecebido);
    totalAReceberEl.textContent = formatBRL(totalAReceber);
    totalCustoEl.textContent = formatBRL(totalCusto);
    lucroTotalEl.textContent = formatBRL(lucroTotal);

    // Gráfico Produtos mais vendidos (soma quantidades vendas não canceladas)
    const produtoQuantidades = {};
    vendas.forEach(v => {
      if (v.status !== 'Cancelado') {
        produtoQuantidades[v.produto] = (produtoQuantidades[v.produto] || 0) + v.quantidade;
      }
    });
    const labelsProd = Object.keys(produtoQuantidades);
    const dataProd = Object.values(produtoQuantidades);

    if (chartProdutos) chartProdutos.destroy();
    chartProdutos = new Chart(graficoProdutosCtx, {
      type: 'bar',
      data: {
        labels: labelsProd,
        datasets: [{
          label: 'Quantidade Vendida',
          data: dataProd,
          backgroundColor: 'rgba(37, 99, 235, 0.7)',
          borderRadius: 6,
          borderSkipped: false
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true }
        },
        scales: {
          y: { beginAtZero: true, stepSize: 1 }
        }
      }
    });

    // Gráfico Status vendas
    const statusCount = { Pendente: 0, Recebido: 0, Cancelado: 0 };
    vendas.forEach(v => {
      statusCount[v.status] = (statusCount[v.status] || 0) + 1;
    });

    if (chartStatus) chartStatus.destroy();
    chartStatus = new Chart(graficoStatusCtx, {
      type: 'doughnut',
      data: {
        labels: ['Pendente', 'Recebido', 'Cancelado'],
        datasets: [{
          data: [statusCount.Pendente, statusCount.Recebido, statusCount.Cancelado],
          backgroundColor: [
            'rgba(251, 191, 36, 0.8)',
            'rgba(22, 163, 74, 0.8)',
            'rgba(220, 38, 38, 0.8)'
          ],
          borderColor: 'rgba(255, 255, 255, 0.9)',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              color: document.documentElement.classList.contains('dark') ? '#eee' : '#333',
              font: { weight: 'bold' }
            }
          }
        }
      }
    });
  }

  // Export CSV
  function exportCSV() {
    let csv = 'Categoria;Nome;Quantidade;Valor Unitário (R$);Custo Unitário (R$);Total (R$);Status;Vencimento\n';
    vendas.forEach(v => {
      const custoUnit = produtos[v.produto] ? produtos[v.produto].custo : 0;
      const total = v.valor * v.quantidade;
      csv += `Venda;${v.produto};${v.quantidade};${v.valor.toFixed(2).replace('.', ',')};${custoUnit.toFixed(2).replace('.', ',')};${total.toFixed(2).replace('.', ',')};${v.status};${formatDateBR(v.vencimento)}\n`;
    });
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'controle_vendas.csv';
    a.click();
    URL.revokeObjectURL(url);
  }

  // Export PDF via jsPDF + autotable
  async function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(18);
    doc.text('Relatório de Vendas & Dívidas', 14, 20);

    const body = vendas.map(v => {
      const custoUnit = produtos[v.produto] ? produtos[v.produto].custo : 0;
      const total = v.valor * v.quantidade;
      return [
        v.devedor,
        v.produto,
        v.quantidade.toString(),
        formatBRL(v.valor),
        formatBRL(custoUnit),
        formatBRL(total),
        v.status,
        formatDateBR(v.vencimento)
      ];
    });

    doc.autoTable({
      head: [['Devedor','Produto','Qtd','Valor Unit.','Custo Unit.','Total','Status','Vencimento']],
      body,
      startY: 30,
      styles: { fontSize: 9 },
      headStyles: { fillColor: '#2563eb', textColor: '#fff' },
      theme: 'striped',
      margin: { left: 14, right: 14 }
    });

    doc.save('relatorio_vendas.pdf');
  }

  // IDs para vendas
  function generateId() {
    return 'v' + Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
  }

  // Atualiza input valorVenda ao mudar produtoVenda
  produtoVendaInput.addEventListener('input', () => {
    const nome = produtoVendaInput.value.trim();
    if (produtos[nome]) {
      valorVendaInput.value = produtos[nome].valor.toFixed(2);
    }
  });

  // Atualiza datalist devedores após mudança de vendas
  function atualizarDevedores() {
    renderDevedores();
  }

  // Form produtos submit
  produtoForm.addEventListener('submit', e => {
    e.preventDefault();
    const nome = nomeProdutoInput.value.trim();
    const valor = parseFloat(valorProdutoInput.value);
    const custo = parseFloat(custoProdutoInput.value);
    if (!nome || isNaN(valor) || isNaN(custo) || valor < 0 || custo < 0) {
      alert("Preencha corretamente todos os campos.");
      return;
    }
    if (produtos[nome]) {
      if (!confirm(`Produto "${nome}" já existe. Deseja atualizar os valores?`)) return;
    }
    produtos[nome] = { valor, custo };
    salvarDados();
    renderProdutos();
    nomeProdutoInput.value = '';
    valorProdutoInput.value = '';
    custoProdutoInput.value = '';
    showNotification(`Produto "${nome}" salvo.`);
  });

  // Exclusão produtos
  produtosTabela.addEventListener('click', e => {
    if (e.target.classList.contains('btnExcluirProduto')) {
      const nome = e.target.dataset.nome;
      if (confirm(`Deseja excluir o produto "${nome}"? Isso removerá também as vendas associadas.`)) {
        delete produtos[nome];
        // Remover vendas associadas
        vendas = vendas.filter(v => v.produto !== nome);
        salvarDados();
        renderProdutos();
        renderVendasTabela();
        renderDashboard();
        atualizarDevedores();
        showNotification(`Produto "${nome}" excluído.`);
      }
    }
  });

  // Form vendas submit
  vendaForm.addEventListener('submit', e => {
    e.preventDefault();
    const devedor = devedorVendaInput.value.trim();
    const produto = produtoVendaInput.value.trim();
    const quantidade = parseInt(quantidadeVendaInput.value);
    const valor = parseFloat(valorVendaInput.value);
    const vencimento = vencimentoVendaInput.value;

    if (!devedor || !produto || isNaN(quantidade) || quantidade < 1 || isNaN(valor) || valor < 0 || !vencimento) {
      alert('Preencha corretamente todos os campos da venda.');
      return;
    }
    if (!produtos[produto]) {
      alert(`Produto "${produto}" não está cadastrado.`);
      return;
    }

    const vendaNova = {
      id: generateId(),
      devedor,
      produto,
      quantidade,
      valor,
      vencimento,
      status: 'Pendente',
      criadoEm: new Date().toISOString()
    };

    vendas.push(vendaNova);
    salvarDados();
    renderVendasTabela();
    renderDashboard();
    atualizarDevedores();

    vendaForm.reset();
    quantidadeVendaInput.value = '1';
    valorVendaInput.value = '';
    showNotification('Venda registrada com sucesso.');
  });

  // Busca vendas debounce
  let buscaTimeout = null;
  buscaVendasInput.addEventListener('input', () => {
    clearTimeout(buscaTimeout);
    buscaTimeout = setTimeout(() => renderVendasTabela(), 300);
  });

  // Ordenar vendas por coluna clicada
  document.querySelectorAll('#tabVendas thead th[data-sort]').forEach(th => {
    th.addEventListener('click', () => {
      const campo = th.dataset.sort;
      if (ordenacao.campo === campo) {
        ordenacao.asc = !ordenacao.asc;
      } else {
        ordenacao.campo = campo;
        ordenacao.asc = true;
      }
      // Ajustar aria-pressed em cabeçalhos
      document.querySelectorAll('#tabVendas thead th[data-sort]').forEach(h => {
        h.setAttribute('aria-pressed', h.dataset.sort === campo ? ordenacao.asc.toString() : 'false');
      });
      renderVendasTabela();
    });
    th.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        th.click();
      }
    });
  });

  // Export buttons
  document.getElementById('exportCsvBtn').addEventListener('click', exportCSV);
  document.getElementById('exportPdfBtn').addEventListener('click', exportPDF);

  // Inicialização geral
  function init() {
    carregarDados();
    renderProdutos();
    renderVendasTabela();
    renderDashboard();
    atualizarDevedores();
    setActiveTab('tabProdutos');
  }
  init();

  // Accessibility: foco no tab ao trocar
  tabButtons.forEach(btn => btn.addEventListener('keydown', e => {
    if (e.key === 'Tab' && !e.shiftKey) {
      const tabId = btn.dataset.tab;
      tabs[tabId.replace('tab','').toLowerCase()].focus();
    }
  }));

})();
</script>

<!-- Screen reader only -->
<style>
.sr-only {
  position: absolute !important;
  width: 1px !important;
  height: 1px !important;
  padding: 0 !important;
  margin: -1px !important;
  overflow: hidden !important;
  clip: rect(0,0,0,0) !important;
  white-space: nowrap !important;
  border: 0 !important;
}
.hidden {
  display:none !important;
}
</style>

</body>
</html>
